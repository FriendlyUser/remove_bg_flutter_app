name: Flutter Android/ Windows
on:
  push:
    branches:
      - main
      - feature/*
  
  jobs:
    android: 
      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '11'
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.0.3'
      - run: flutter pub get
      - run: flutter build appbundle
      - run: echo $GPLAY_KEY_B64 | base64 --decode > android/pc-api-7819418006086265513-297-141698a71862.json
        name: decode json file to upload to google play
      - run: echo $KEY_PROPERTIES_B64 | base64 --decode > android/key.properties
        name: Decoding Key Properties
      - run: echo $JKS_FILE_B64 | base64 --decode > android/keystore.jks
        name: Decode jks file


      - uses: actions/setup-ruby@v1
        with:
          ruby-version: '2.7.2'
      - uses: maierj/fastlane-action@v2.0.1
        if: endsWith(github.ref, '/develop')
        with:
          lane: beta
          subdirectory: 'android'

      - uses: maierj/fastlane-action@v2.0.1
        # if: endsWith(github.ref, '/main')
        with:
          lane: deploy
          subdirectory: 'android' 

      - uses: actions/upload-artifact@v3
        with:
          name: apk
          path: build/app/outputs/apk/release/*.apk # or path/to/artifact

      - uses: actions/upload-artifact@v3
        with:
          name: aab
          path: build/app/outputs/aab/release/*.aab # or path/to/artifact
